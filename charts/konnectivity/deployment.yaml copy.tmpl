
{{- $baseName         := include "konnectivity.name" . -}}
{{- $selectorLabels   := include "konnectivity.selectorLabels" . -}}
{{- $commonLabels     := include "konnectivity.labels" . -}}
{{- $currentNamespace := .Release.Namespace -}}

{{- with .Values.applications.konnectivityServer.Deployment }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ $baseName }}-server"

  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

spec:
  replicas: {{ .replicas }}

  {{- with .strategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  selector:
    matchLabels:
      {{- $selectorLabels | nindent 6 }}

  template:
    metadata:
      labels:
        {{- $commonLabels | nindent 8 }}
      {{- with .metadata.labels }}
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .metadata.annotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

    spec:
  
      {{- with .tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              podAffinityTerm:
                topologyKey: {{ .affinity.topologyKey}}
                labelSelector:
                  matchLabels:
                    {{- $selectorLabels | nindent 20 }}

      automountServiceAccountToken: {{ .automountServiceAccountToken }}

      {{- with .containers.konnectivityServer }}
      containers:
        - name: {{ $baseName }}-server
          image: {{ .image }}
          imagePullPolicy: {{ .imagePullPolicy }}

          {{- with .resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          {{- with .ports }}
          ports:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          {{- with .envs }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          
          {{- with .entryPoint.command }}
          command:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          args:
            - --logtostderr=true
            - --server-id=$(POD_NAME)
            - --cluster-cert=/pki/apiserver/tls.crt
            - --cluster-key=/pki/apiserver/tls.key
            - --mode=grpc
            - --uds-name=/run/konnectivity-server/konnectivity-server.socket
            - --server-port=0
            - --agent-port=8132
            - --admin-port=8133
            - --health-port=8134
            - --agent-namespace=kube-system
            - --agent-service-account=konnectivity-agent
            - --kubeconfig=/etc/kubernetes/admin.conf
            - --authentication-audience=system:konnectivity-server
            - --keepalive-time=1h

          {{- with .livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          volumeMounts:
            - mountPath: /pki/{{ $baseName }}-server
              name: pki-{{ $baseName }}server
            - mountPath: /pki/kubeconfig
              name: pki-{{ $baseName }}-client
          {{- with .volumeMounts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}

      {{- end }}

      volumes:
        - secret:
            secretName: "pki-{{ $baseName }}-server"
          name: pki-{{ $baseName }}server
        - secret:
            secretName: "pki-{{ $baseName }}-client"
          name: pki-{{ $baseName }}-client
        {{- with .volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

{{- end}}