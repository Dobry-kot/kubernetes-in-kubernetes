{{- $baseName         := include "konnectivity.name" . -}}
{{- $commonLabels     := include "konnectivity.labels" . -}}
{{- $currentNamespace := .Release.Namespace -}}

{{- with .Values.applications.konnectivityServer.Certificates }}
{{- with .ca }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "pki-{{- $baseName }}-ca"
  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  commonName: "{{ $baseName }}-ca"
  secretName: "pki-{{- $baseName }}-ca"
  duration: "{{ .duration }}{{- .measurement }}"
  renewBefore: "{{ .renewBefore }}{{- .measurement }}"
  subject:
    organizations:
      - "{{- $currentNamespace }}"
    {{- range $organization := .subject.organizations }}
      - "{{ $organization }}"
    {{- end }}

  {{- with .usages }}
  usages:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  isCA: {{ .isCA }}
  issuerRef:
    name: "{{ .issuerRefName }}"
    kind: Issuer

---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: "{{ $baseName }}-issuer"
  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  ca:
    secretName: "pki-{{- $baseName }}-ca"
{{- end }}

{{- with .server }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "pki-{{- $baseName }}-server"
  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  commonName: "{{ $baseName }}-server"
  secretName: "pki-{{- $baseName }}-server"
  duration: "{{ .duration }}{{- .measurement }}"
  renewBefore: "{{ .renewBefore }}{{- .measurement }}"

  subject:
    organizations:
      - "{{- $currentNamespace }}"
    {{- range $organization := .subject.organizations }}
      - "{{ $organization }}"
    {{- end }}

  {{- with .usages }}
  usages:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  dnsNames:
    - "{{ $baseName }}-server-svc"
    - "{{ $baseName }}-server-svc.{{- $currentNamespace }}"
    - "{{ $baseName }}-server-svc.{{- $currentNamespace }}.svc"
  {{- with .dnsNames }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .ipAddresses }}
  ipAddresses:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  issuerRef:
    name: "{{- $baseName }}-issuer"
    kind: Issuer
{{- end }}
{{- with .client }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "pki-{{- $baseName }}-client"
  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  commonName: "{{ $baseName }}-client"
  secretName: "pki-{{- $baseName }}-client"
  duration: "{{ .duration }}{{- .measurement }}"
  renewBefore: "{{ .renewBefore }}{{- .measurement }}"
  subject:
    organizations:
      - "{{- $currentNamespace }}"
    {{- range $organization := .subject.organizations }}
      - "{{ $organization }}"
    {{- end }}

  {{- with .usages }}
  usages:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  issuerRef:
    name: "{{- $baseName }}-issuer"
    kind: Issuer
{{- end }}
{{- with .serverClient }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: "pki-{{- $baseName }}-server-client"
  labels:
    {{- $commonLabels | nindent 4 }}
  {{- with .metadata.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .metadata.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  commonName: "system:{{- $baseName }}-server"
  secretName: "pki-{{- $baseName }}-server-client"
  duration: "{{ .duration }}{{- .measurement }}"
  renewBefore: "{{ .renewBefore }}{{- .measurement }}"

  subject:
    organizations:
      - "{{- $currentNamespace }}"
    {{- range $organization := .subject.organizations }}
      - "{{ $organization }}"
    {{- end }}

  {{- with .usages }}
  usages:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  issuerRef:
    name: "issuer"
    kind: Issuer
{{- end }}
{{- end }}